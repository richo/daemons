<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Daemons::Application</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Daemons::Application</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/daemons/application_rb.html">
                lib/daemons/application.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000027">exception_log</a>&nbsp;&nbsp;
      <a href="#M000021">logfile</a>&nbsp;&nbsp;
      <a href="#M000018">new</a>&nbsp;&nbsp;
      <a href="#M000020">pidfile_dir</a>&nbsp;&nbsp;
      <a href="#M000032">running?</a>&nbsp;&nbsp;
      <a href="#M000019">script</a>&nbsp;&nbsp;
      <a href="#M000031">show_status</a>&nbsp;&nbsp;
      <a href="#M000026">start</a>&nbsp;&nbsp;
      <a href="#M000023">start_exec</a>&nbsp;&nbsp;
      <a href="#M000024">start_load</a>&nbsp;&nbsp;
      <a href="#M000022">start_none</a>&nbsp;&nbsp;
      <a href="#M000025">start_proc</a>&nbsp;&nbsp;
      <a href="#M000028">stop</a>&nbsp;&nbsp;
      <a href="#M000029">zap</a>&nbsp;&nbsp;
      <a href="#M000030">zap!</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">app_argv</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">controller_argv</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">group</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the <a href="ApplicationGroup.html">ApplicationGroup</a> the application
belongs to

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">options</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
my private options

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">pid</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the <a href="Pid.html">Pid</a> instance belonging to this application

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000018" class="method-detail">
        <a name="M000018"></a>

        <div class="method-heading">
          <a href="#M000018" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(group, add_options = {}, pid = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000018-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000018-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 22</span>
22:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">group</span>, <span class="ruby-identifier">add_options</span> = {}, <span class="ruby-identifier">pid</span> = <span class="ruby-keyword kw">nil</span>)
23:       <span class="ruby-ivar">@group</span> = <span class="ruby-identifier">group</span>
24:       <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">group</span>.<span class="ruby-identifier">options</span>.<span class="ruby-identifier">dup</span>
25:       <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">add_options</span>)
26:       
27:       <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@pid</span> = <span class="ruby-identifier">pid</span>
28:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">dir</span> = <span class="ruby-identifier">pidfile_dir</span>
29:           <span class="ruby-ivar">@pid</span> = <span class="ruby-constant">PidFile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">pidfile_dir</span>(), <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span>, <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">multiple</span>)
30:         <span class="ruby-keyword kw">else</span>
31:           <span class="ruby-ivar">@pid</span> = <span class="ruby-constant">PidMem</span>.<span class="ruby-identifier">new</span>
32:         <span class="ruby-keyword kw">end</span>
33:       <span class="ruby-keyword kw">end</span>
34:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000027" class="method-detail">
        <a name="M000027"></a>

        <div class="method-heading">
          <a href="#M000027" class="method-signature">
          <span class="method-name">exception_log</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This is a nice little function for debugging purposes: In case a
multi-threaded ruby script exits due to an uncaught exception it may be
difficult to find out where the exception came from because one cannot
catch exceptions that are thrown in threads other than the main thread.
</p>
<p>
This function searches for all exceptions in memory and outputs them to
STDERR (if it is connected) and to a log file in the pid-file directory.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000027-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000027-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 216</span>
216:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">exception_log</span>
217:       <span class="ruby-identifier">require</span> <span class="ruby-value str">'logger'</span>
218:       
219:       <span class="ruby-identifier">l_file</span> = <span class="ruby-constant">Logger</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">pidfile_dir</span>(), <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'.log'</span>))
220:       
221:       
222:       <span class="ruby-comment cmt"># the code below only logs the last exception</span>
223: <span class="ruby-comment cmt">#       e = nil</span>
224: <span class="ruby-comment cmt">#       </span>
225: <span class="ruby-comment cmt">#       ObjectSpace.each_object {|o|</span>
226: <span class="ruby-comment cmt">#         if ::Exception === o</span>
227: <span class="ruby-comment cmt">#           e = o</span>
228: <span class="ruby-comment cmt">#         end</span>
229: <span class="ruby-comment cmt">#       }</span>
230: <span class="ruby-comment cmt">#       </span>
231: <span class="ruby-comment cmt">#       l_file.error e</span>
232: <span class="ruby-comment cmt">#       l_file.close</span>
233:       
234:       <span class="ruby-comment cmt"># this code logs every exception found in memory</span>
235:       <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">each_object</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
236:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">::</span><span class="ruby-constant">Exception</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">o</span>
237:           <span class="ruby-identifier">l_file</span>.<span class="ruby-identifier">error</span> <span class="ruby-identifier">o</span>
238:         <span class="ruby-keyword kw">end</span>
239:       }
240:       
241:       <span class="ruby-identifier">l_file</span>.<span class="ruby-identifier">close</span>
242:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000021" class="method-detail">
        <a name="M000021"></a>

        <div class="method-heading">
          <a href="#M000021" class="method-signature">
          <span class="method-name">logfile</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000021-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000021-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 44</span>
44:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">logfile</span>
45:       (<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:log_output</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pidfile_dir</span>()) <span class="ruby-operator">?</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">pidfile_dir</span>(), <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">app_name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'.output'</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
46:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000020" class="method-detail">
        <a name="M000020"></a>

        <div class="method-heading">
          <a href="#M000020" class="method-signature">
          <span class="method-name">pidfile_dir</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000020-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000020-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 40</span>
40:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pidfile_dir</span>
41:       <span class="ruby-constant">Pid</span>.<span class="ruby-identifier">dir</span>(<span class="ruby-ivar">@dir_mode</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">dir_mode</span>, <span class="ruby-ivar">@dir</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">dir</span>, <span class="ruby-ivar">@script</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">script</span>)
42:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000032" class="method-detail">
        <a name="M000032"></a>

        <div class="method-heading">
          <a href="#M000032" class="method-signature">
          <span class="method-name">running?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This function implements a (probably too simle) method to detect whether
the program with the pid found in the pid-file is still running. It just
searches for the pid in the output of <tt>ps ax</tt>, which is probably not
a good idea in some cases. Alternatives would be to use a direct access
method the unix process control system.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000032-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000032-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 289</span>
289:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">running?</span>
290:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">exists?</span>
291:         <span class="ruby-keyword kw">return</span> <span class="ruby-constant">Pid</span>.<span class="ruby-identifier">running?</span>(<span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span>)
292:       <span class="ruby-keyword kw">end</span>
293:       
294:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
295:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000019" class="method-detail">
        <a name="M000019"></a>

        <div class="method-heading">
          <a href="#M000019" class="method-signature">
          <span class="method-name">script</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000019-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000019-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 36</span>
36:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">script</span>
37:       <span class="ruby-ivar">@script</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">script</span>
38:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000031" class="method-detail">
        <a name="M000031"></a>

        <div class="method-heading">
          <a href="#M000031" class="method-signature">
          <span class="method-name">show_status</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000031-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000031-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 276</span>
276:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">show_status</span>
277:       <span class="ruby-identifier">running</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">running?</span>
278:       
279:       <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{self.group.app_name}: #{running ? '' : 'not '}running#{(running and @pid.exists?) ? ' [pid ' + @pid.pid.to_s + ']' : ''}#{(@pid.exists? and not running) ? ' (but pid-file exists: ' + @pid.pid.to_s + ')' : ''}&quot;</span>
280:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000026" class="method-detail">
        <a name="M000026"></a>

        <div class="method-heading">
          <a href="#M000026" class="method-signature">
          <span class="method-name">start</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000026-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000026-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 173</span>
173:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>
174:       <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">create_monitor</span>(<span class="ruby-ivar">@group</span>.<span class="ruby-identifier">applications</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">||</span> <span class="ruby-keyword kw">self</span>)
175:       
176:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:mode</span>]
177:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:none</span>
178:           <span class="ruby-identifier">start_none</span>
179:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:exec</span>
180:           <span class="ruby-identifier">start_exec</span>
181:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:load</span>
182:           <span class="ruby-identifier">start_load</span>
183:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:proc</span>
184:           <span class="ruby-identifier">start_proc</span>
185:         <span class="ruby-keyword kw">else</span>
186:           <span class="ruby-identifier">start_load</span>
187:       <span class="ruby-keyword kw">end</span>
188:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000023" class="method-detail">
        <a name="M000023"></a>

        <div class="method-heading">
          <a href="#M000023" class="method-signature">
          <span class="method-name">start_exec</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000023-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000023-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 87</span>
 87:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_exec</span>
 88:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ontop</span>]
 89:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">logfile</span>)
 90:       <span class="ruby-keyword kw">else</span>
 91:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">logfile</span>)
 92:       <span class="ruby-keyword kw">end</span>
 93:       
 94:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
 95:         
 96:       <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'DAEMONS_ARGV'</span>] = <span class="ruby-ivar">@controller_argv</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>)      
 97:       <span class="ruby-comment cmt"># haven't tested yet if this is really passed to the exec'd process...</span>
 98:       
 99:       <span class="ruby-constant">Kernel</span>.<span class="ruby-identifier">exec</span>(<span class="ruby-identifier">script</span>(), <span class="ruby-operator">*</span><span class="ruby-constant">ARGV</span>)
100:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000024" class="method-detail">
        <a name="M000024"></a>

        <div class="method-heading">
          <a href="#M000024" class="method-signature">
          <span class="method-name">start_load</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000024-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000024-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 102</span>
102:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_load</span>
103:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ontop</span>]
104:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">daemonize</span>(<span class="ruby-identifier">logfile</span>)
105:       <span class="ruby-keyword kw">else</span>
106:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">logfile</span>)
107:       <span class="ruby-keyword kw">end</span>
108:       
109:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
110:       
111:       
112:       <span class="ruby-comment cmt"># We need this to remove the pid-file if the applications exits by itself.</span>
113:       <span class="ruby-comment cmt"># Note that &lt;tt&gt;at_text&lt;/tt&gt; will only be run if the applications exits by calling </span>
114:       <span class="ruby-comment cmt"># &lt;tt&gt;exit&lt;/tt&gt;, and not if it calls &lt;tt&gt;exit!&lt;/tt&gt; (so please don't call &lt;tt&gt;exit!&lt;/tt&gt;</span>
115:       <span class="ruby-comment cmt"># in your application!</span>
116:       <span class="ruby-comment cmt">#</span>
117:       <span class="ruby-identifier">at_exit</span> {
118:         <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
119:         
120:         <span class="ruby-comment cmt"># If the option &lt;tt&gt;:backtrace&lt;/tt&gt; is used and the application did exit by itself</span>
121:         <span class="ruby-comment cmt"># create a exception log.</span>
122:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:backtrace</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ontop</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">$daemons_sigterm</span>
123:           <span class="ruby-identifier">exception_log</span>() <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
124:         <span class="ruby-keyword kw">end</span>
125:           
126:       }
127:       
128:       <span class="ruby-comment cmt"># This part is needed to remove the pid-file if the application is killed by </span>
129:       <span class="ruby-comment cmt"># daemons or manually by the user.</span>
130:       <span class="ruby-comment cmt"># Note that the applications is not supposed to overwrite the signal handler for</span>
131:       <span class="ruby-comment cmt"># 'TERM'.</span>
132:       <span class="ruby-comment cmt">#</span>
133:       <span class="ruby-identifier">trap</span>(<span class="ruby-value str">'TERM'</span>) {
134:         <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
135:         <span class="ruby-identifier">$daemons_sigterm</span> = <span class="ruby-keyword kw">true</span>
136:         
137:         <span class="ruby-identifier">exit</span>
138:       }
139:       
140:       <span class="ruby-comment cmt"># Know we really start the script...</span>
141:       <span class="ruby-identifier">$DAEMONS_ARGV</span> = <span class="ruby-ivar">@controller_argv</span>
142:       <span class="ruby-constant">ENV</span>[<span class="ruby-value str">'DAEMONS_ARGV'</span>] = <span class="ruby-ivar">@controller_argv</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">' '</span>)
143:       
144:       <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">clear</span>
145:       <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">concat</span> <span class="ruby-ivar">@app_argv</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@app_argv</span>
146:       
147:       <span class="ruby-comment cmt"># TODO: begin - rescue - end around this and exception logging</span>
148:       <span class="ruby-identifier">load</span> <span class="ruby-identifier">script</span>()
149:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000022" class="method-detail">
        <a name="M000022"></a>

        <div class="method-heading">
          <a href="#M000022" class="method-signature">
          <span class="method-name">start_none</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000022-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000022-source">
<pre>
    <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 48</span>
48:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_none</span>
49:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ontop</span>]
50:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">daemonize</span> <span class="ruby-comment cmt">#(logfile)</span>
51:       <span class="ruby-keyword kw">else</span>
52:         <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>
53:       <span class="ruby-keyword kw">end</span>
54:       
55:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">pid</span>
56:       
57:       
58:       <span class="ruby-comment cmt"># We need this to remove the pid-file if the applications exits by itself.</span>
59:       <span class="ruby-comment cmt"># Note that &lt;tt&gt;at_text&lt;/tt&gt; will only be run if the applications exits by calling </span>
60:       <span class="ruby-comment cmt"># &lt;tt&gt;exit&lt;/tt&gt;, and not if it calls &lt;tt&gt;exit!&lt;/tt&gt; (so please don't call &lt;tt&gt;exit!&lt;/tt&gt;</span>
61:       <span class="ruby-comment cmt"># in your application!</span>
62:       <span class="ruby-comment cmt">#</span>
63:       <span class="ruby-identifier">at_exit</span> {
64:         <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
65:         
66:         <span class="ruby-comment cmt"># If the option &lt;tt&gt;:backtrace&lt;/tt&gt; is used and the application did exit by itself</span>
67:         <span class="ruby-comment cmt"># create a exception log.</span>
68:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:backtrace</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ontop</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">$daemons_sigterm</span>
69:           <span class="ruby-identifier">exception_log</span>() <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
70:         <span class="ruby-keyword kw">end</span>
71:           
72:       }
73:       
74:       <span class="ruby-comment cmt"># This part is needed to remove the pid-file if the application is killed by </span>
75:       <span class="ruby-comment cmt"># daemons or manually by the user.</span>
76:       <span class="ruby-comment cmt"># Note that the applications is not supposed to overwrite the signal handler for</span>
77:       <span class="ruby-comment cmt"># 'TERM'.</span>
78:       <span class="ruby-comment cmt">#</span>
79:       <span class="ruby-identifier">trap</span>(<span class="ruby-value str">'TERM'</span>) {
80:         <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
81:         <span class="ruby-identifier">$daemons_sigterm</span> = <span class="ruby-keyword kw">true</span>
82:         
83:         <span class="ruby-identifier">exit</span>
84:       }
85:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000025" class="method-detail">
        <a name="M000025"></a>

        <div class="method-heading">
          <a href="#M000025" class="method-signature">
          <span class="method-name">start_proc</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000025-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000025-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 151</span>
151:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_proc</span>
152:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:proc</span>]
153:       
154:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:ontop</span>]
155:         <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">call_as_daemon</span>(<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:proc</span>], <span class="ruby-identifier">logfile</span>)
156:       <span class="ruby-keyword kw">else</span>
157: <span class="ruby-comment cmt">#         Daemonize.simulate(logfile)</span>
158: <span class="ruby-comment cmt">#         </span>
159: <span class="ruby-comment cmt">#         @pid.pid = Process.pid</span>
160: <span class="ruby-comment cmt">#         </span>
161: <span class="ruby-comment cmt">#         Thread.new(&amp;options[:proc])</span>
162:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span> = <span class="ruby-constant">Process</span>.<span class="ruby-identifier">fork</span>
163:           <span class="ruby-constant">Daemonize</span>.<span class="ruby-identifier">simulate</span>(<span class="ruby-identifier">logfile</span>)
164:           <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:proc</span>].<span class="ruby-identifier">call</span>
165:           <span class="ruby-identifier">exit</span>
166:         <span class="ruby-keyword kw">else</span>
167:           <span class="ruby-constant">Process</span>.<span class="ruby-identifier">detach</span>(<span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span>)
168:         <span class="ruby-keyword kw">end</span>
169:       <span class="ruby-keyword kw">end</span>
170:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000028" class="method-detail">
        <a name="M000028"></a>

        <div class="method-heading">
          <a href="#M000028" class="method-signature">
          <span class="method-name">stop</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000028-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000028-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 245</span>
245:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop</span>
246:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:force</span>] <span class="ruby-keyword kw">and</span> <span class="ruby-keyword kw">not</span> <span class="ruby-identifier">running?</span>
247:         <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">zap</span>
248:         <span class="ruby-keyword kw">return</span>
249:       <span class="ruby-keyword kw">end</span>
250:       
251:       <span class="ruby-comment cmt"># Catch errors when trying to kill a process that doesn't</span>
252:       <span class="ruby-comment cmt"># exist. This happens when the process quits and hasn't been</span>
253:       <span class="ruby-comment cmt"># restarted by the monitor yet. By catching the error, we allow the</span>
254:       <span class="ruby-comment cmt"># pid file clean-up to occur.</span>
255:       <span class="ruby-keyword kw">begin</span>
256:         <span class="ruby-constant">Process</span>.<span class="ruby-identifier">kill</span>(<span class="ruby-value str">'TERM'</span>, <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">pid</span>)
257:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ESRCH</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
258:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;#{e} #{@pid.pid}&quot;</span>
259:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;deleting pid-file.&quot;</span>
260:       <span class="ruby-keyword kw">end</span>
261:       
262:       <span class="ruby-comment cmt"># We try to remove the pid-files by ourselves, in case the application</span>
263:       <span class="ruby-comment cmt"># didn't clean it up.</span>
264:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
265:       
266:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000029" class="method-detail">
        <a name="M000029"></a>

        <div class="method-heading">
          <a href="#M000029" class="method-signature">
          <span class="method-name">zap</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000029-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000029-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 268</span>
268:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">zap</span>
269:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span>
270:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000030" class="method-detail">
        <a name="M000030"></a>

        <div class="method-heading">
          <a href="#M000030" class="method-signature">
          <span class="method-name">zap!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000030-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000030-source">
<pre>
     <span class="ruby-comment cmt"># File lib/daemons/application.rb, line 272</span>
272:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">zap!</span>
273:       <span class="ruby-ivar">@pid</span>.<span class="ruby-identifier">cleanup</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
274:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>